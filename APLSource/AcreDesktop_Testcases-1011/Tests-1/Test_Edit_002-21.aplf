 R←Test_Edit_002(stopFlag batchFlag);⎕TRAP;caption;rc;cmd;parms;_;acreDir;log
⍝ Make changes via the editor and check whether acre takes appropriate action.
⍝ For that to work we start an independent instance of Dyalog with a main windows that has
⍝ a particular randomly generated caption so that we can send keystrokes to that session.
⍝ That independent session (the WS Tests\edit.dws) creates an acre project for this and
⍝ redirects all output generated by acre to a global vars which is finally written to
⍝ a file "acrelog.txt" so that we can check what acre actually did.
 ⎕TRAP←(999 'C' '. ⍝ Deliberate error')(0 'N')

 :If 1
     R←T._Inactive        ⍝ One some machines this test always failes, on some rarely, on some it makes APL disappear
                        ⍝ To be re-written when the Ride protocol can be used to drive test cases. ⍝TODO⍝
     :Return
 :EndIf

 :If 'Win'≢3↑1⊃'#'⎕WG'APLVersion'
     R←∆WindowsOnly
     :Return
 :EndIf

 R←T._Failed

 ⎕←'   This test starts a second instance of Dyalog and communicates with it.'
 ⎕←'   That''s why this requires some delays, and there is nothing we can do about this.'

 caption←⎕A[?(⍴⎕A)⍴⍴⎕A]
 cmd←'"',(1⊃2 ⎕NQ #'GetCommandLineArgs'),'" '
 cmd←'APL-64 17.0 '⎕R'APL-64 15.0 '⊣cmd
 cmd,←'Captions\Editor=',caption,'-E '
 cmd,←'Captions\Session=',caption,'-S '
 cmd,←'Captions\ExitDyalog=',caption,'-X '
 cmd,←'Captions\MessageBox=',caption,'-M '
 cmd,←'confirm_Fix=0 '
 cmd,←'Edit.dws '
 acreDir←F.GetTempPath,⊃⎕SI
 F.RmDir acreDir
 cmd,←'-acredir="',acreDir,'" '
 cmd,←'-testfns="',(⊃⎕SI),'" '
 :If 0
     cmd,←'-lx '
 :EndIf
 parms←##.Execute.DefaultParms
 parms.dir←F.PWD,'\Tests'
 parms.hidden←0
 parms.wait←0
 rc←parms ##.Execute.Application cmd
 'Could not start second APL instance'Assert 0=⊃rc
 ⎕DL 5
⍝ (caption,'-E')∆SendKeyStroke⊂'{Down}'         ⍝ Sometimes ignored, therefore we settle for a variable
 (caption,'-E')∆SendKeyStroke⊂'{End}'
⍝ (caption,'-E')∆SendKeyStroke⊂'{Left}'         ⍝ Sometimes ignored, therefore we settle for a variable
 (caption,'-E')∘∆SendKeyStroke' and all the rest'
 ⎕DL 0.5
 (caption,'-E')∆SendKeyStroke⊂'{Esc}'
 ⎕DL 1      ⍝ Otherwise this APL instance will stop for some reason
 :If ∆WaitForFile acreDir,'\acrelog.txt'
     log←A.ReadUtf8File acreDir,'\acrelog.txt'
     →T.GoToTidyUp 3≠⍴log   ⍝ [1]=acre version  [2]=Added script...  [3]=Change
 :Else
     →T.GoToTidyUp 1
 :EndIf

 R←T._OK

∆TidyUp:
 F.RmDir acreDir
⍝Done
