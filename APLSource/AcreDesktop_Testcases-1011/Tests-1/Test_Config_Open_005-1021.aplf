 R←Test_Config_Open_005(stopFlag batchFlag);⎕TRAP;projectPath;bin;configFilename;buff;dmx
⍝ Create a project and check whether an invalid config file makes acre signal an error (was once a bug)
⍝ This is the user exit that allows the execution of any source code management command like Git's "Commit".
 ⎕TRAP←(999 'C' '. ⍝ Deliberate error')(0 'N')

 R←∆Failed

 ∆ClearLog
 #.⎕SHADOW'TEMP'
 'TEMP'#.⎕NS''
 Assert' '=1↑0⍴⊃#.TEMP.⎕FX↑'r←Hello' 'a←''World'''
 projectPath←F.GetTempPath,⊃⎕SI
 F.RmDir projectPath

 :Trap (~stopFlag)/0
     {}∆RunUcmd'Createproject "',projectPath,'" #.TEMP'
 :Else
     →GoToTidyUp 1
 :EndTrap

 ∆RunUcmd'Close #.TEMP'
 #.⎕EX'TEMP'

 configFilename←2⊃∆ReadConfigFile projectPath
 buff←''
 buff,←⊂'['
 buff,←⊂'   Open←'''''
 buff,←⊂'   ProjectSpace←''#.TEMP'''
 buff,←⊂'   StartUp='''''               ⍝ Watch out: invalid syntax!
 buff,←⊂']'
 A.WriteUtf8File configFilename buff

 :Trap 0
     {}∆RunUcmd'OpenProject ',projectPath
     →GoToTidyUp 1
 :Else
     dmx←⎕DMX
     →PassesIf dmx.EN∊11 911
⍝     . ⍝TODO⍝  ⍝TODO⍝  ⍝TODO⍝      →PassesIf'NONCE ERROR character error'{⍺≡(≢⍺)↑⍵}⊃dmx.DM
     →PassesIf'Problem reading'(1∊⍷)⊃dmx.DM
 :EndTrap

 R←∆OK

∆TidyUp:
 :Trap 0 ⋄ F.RmDir projectPath ⋄ :EndTrap
 ∆ClearLog
 ∆RunUcmd'Close #.TEMP'
⍝Done
